<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Zoom Ranger Grips</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="../dist/uPlot.min.css">
		<style>
			.uplot {
				display: block;
				width: 800px;
			}

			.u-axis {
				pointer-events: none;
			}

			.u-select {
				pointer-events: all;
				cursor: grabbing;
			}

			.u-grip-l {
				position: absolute;
				left: -5px;
				width: 10px;
				height: 100%;
				background: red;
				cursor: ew-resize;
			}

			.u-grip-r {
				position: absolute;
				right: -5px;
				width: 10px;
				height: 100%;
				background: blue;
				cursor: ew-resize;
			}
		</style>
	</head>
	<body>
		<script src="../dist/uPlot.iife.js"></script>
		<script>
			let loop = 100;

			let data = [
				Array(loop),
				Array(loop),
			];

			for (let i = 0; i < loop; i++) {
				let x = 2 * Math.PI * i / loop;
				let y = Math.sin(x);

				data[0][i] = x;
				data[1][i] = y;
			}

			let initXmin = 1;
			let initXmax = 4.5;

			//----------------

			const doc = document;

			function debounce(fn) {
				let raf;

				return (...args) => {
					if (raf)
						return;

					raf = requestAnimationFrame(() => {
						fn(...args);
						raf = null;
					});
				};
			}

			function placeDiv(par, cls) {
				let el = doc.createElement("div");
				el.classList.add(cls);
				par.appendChild(el);
				return el;
			}

			function on(ev, el, fn) {
				el.addEventListener(ev, fn);
			}

			function off(ev, el, fn) {
				el.removeEventListener(ev, fn);
			}

			//----------------

			let x0;
			let lft0;
			let rgt0;

			const lftWid = {left: null, width: null};
			const minMax = {min: null, max: null};

			const BOUNDARY_LEFT  = 0;
			const BOUNDARY_RIGHT = 1;
			const BOUNDARY_BOTH  = 2;

			function update(newLft, newRgt, movedBoundary) {
				let maxRgt = uRanger.bbox.width / uPlot.pxRatio;

				if (movedBoundary == BOUNDARY_BOTH) {
					let initWidth = newRgt - newLft;

					if (newRgt > maxRgt) {
						newRgt = maxRgt;
						newLft = newRgt-initWidth;
					}
					else if (newLft < 0) {
						newLft = 0;
						newRgt = newLft+initWidth;
					}
				}
				else {
					if (newLft > newRgt) {
						if (movedBoundary == BOUNDARY_LEFT)
							newLft = newRgt;
						else if (movedBoundary == BOUNDARY_RIGHT)
							newRgt = newLft;
					}

					newLft = Math.max(0, newLft);
					newRgt = Math.min(newRgt, maxRgt);
				}

				zoom(newLft, newRgt - newLft);
			}

			function select(newLft, newWid) {
				lftWid.left = newLft;
				lftWid.width = newWid;
				uRanger.setSelect(lftWid, false);
			}

			function zoom(newLft, newWid) {
				minMax.min = uRanger.posToVal(newLft, 'x');
				minMax.max = uRanger.posToVal(newLft + newWid, 'x');
				uZoomed.setScale('x', minMax);
			}

			function bindMove(e, onMove) {
				x0 = e.clientX;
				lft0 = uRanger.select.left;
				rgt0 = lft0 + uRanger.select.width;

				const _onMove = debounce(onMove);
				on("mousemove", doc, _onMove);

				const _onUp = e => {
					off("mouseup", doc, _onUp);
					off("mousemove", doc, _onMove);
					viaGrip = false;
				};
				on("mouseup", doc, _onUp);

				e.stopPropagation();
			}

			//----------------

			function getSize(height) {
				return {
					width: window.innerWidth - 100,
					height: height,
				}
			}

			const rangerOpts = {
				width: 800,
				height: 100,
				cursor: {
					x: false,
					y: false,
					points: {
						show: false,
					},
					drag: {
						setScale: false,
						setSelect: true,
						x: true,
						y: false,
					},
				},
				legend: {
					show: false
				},
				scales: {
					x: {
						time: false,
					},
				},
				series: [
					{},
					{
						stroke: "red",
					}
				],
				hooks: {
					ready: [
						uRanger => {
							let left = Math.round(uRanger.valToPos(initXmin, 'x'));
							let width = Math.round(uRanger.valToPos(initXmax, 'x')) - left;
							let height = uRanger.bbox.height / devicePixelRatio;
							uRanger.setSelect({left, width, height}, false);

							const sel = uRanger.root.querySelector(".u-select");

							on("mousedown", sel, e => {
								bindMove(e, e => update(lft0 + (e.clientX - x0), rgt0 + (e.clientX - x0), BOUNDARY_BOTH));
							});

							on("mousedown", placeDiv(sel, "u-grip-l"), e => {
								bindMove(e, e => update(lft0 + (e.clientX - x0), rgt0, BOUNDARY_LEFT));
							});

							on("mousedown", placeDiv(sel, "u-grip-r"), e => {
								bindMove(e, e => update(lft0, rgt0 + (e.clientX - x0), BOUNDARY_RIGHT));
							});
						}
					],
					setSelect: [
						uRanger => {
							zoom(uRanger.select.left, uRanger.select.width);
						}
					],
				}
			};

			let uRanger = new uPlot(rangerOpts, data, document.body);

			const zoomedOpts = {
			//	title: "Zoomed Area",
				width: 800,
				height: 400,
				cursor: {
					drag: {
						x: true,
						y: false
					},
				},
				select: {
					over: false,
				},
				scales: {
					x: {
						time: false,
						min: initXmin,
						max: initXmax,
					},
				},
				series: [
					{
						label: "x",
					},
					{
						label: "sin(x)",
						stroke: "red",
					}
				],
				hooks : {
					setScale : [
						uZoomed => {
							let left = Math.round(uRanger.valToPos(uZoomed.scales.x.min, 'x'));
							let right = Math.round(uRanger.valToPos(uZoomed.scales.x.max, 'x'));
							select(left, right-left);
						}
					]
				}
			};

			let uZoomed = new uPlot(zoomedOpts, data, document.body);
		</script>
	</body>
</html>